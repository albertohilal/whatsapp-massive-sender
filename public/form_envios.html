<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Generar Envíos de WhatsApp</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      padding: 0.5rem;
      border: 1px solid #ccc;
      text-align: left;
    }
    th {
      background: #eee;
    }
    select, input {
      margin-right: 1rem;
      padding: 0.4rem;
    }
  </style>
</head>
<body>

  <h2>Enviar Campaña de WhatsApp</h2>

  <div>
    <label for="campania">Seleccionar Campaña</label>
    <select id="campania"></select>
  </div>

  <div style="margin-top: 1rem;">
    <label for="filtroRubro">Filtrar por Rubro:</label>
    <select id="filtroRubro">
      <option value="">Todos</option>
    </select>

    <label for="filtroDireccion">Dirección contiene:</label>
    <input type="text" id="filtroDireccion" placeholder="Ej: Lomas, Lanús..." />
  </div>

  <h3>Lugares disponibles</h3>
  <table>
    <thead>
      <tr>
        <th><input type="checkbox" id="selectAll" /></th>
        <th>Nombre</th>
        <th>Teléfono</th>
        <th>Rubro</th>
        <th>Dirección</th>
      </tr>
    </thead>
    <tbody id="tablaLugares"></tbody>
  </table>

  <button onclick="generarEnvios()">Generar Envíos</button>

  <script>
    let lugares = [];

    async function cargarCampanias() {
      const res = await fetch('/api/campanias');
      const data = await res.json();
      const select = document.getElementById('campania');
      data.forEach(c => {
        const option = document.createElement('option');
        option.value = c.id;
        option.textContent = `${c.id} - ${c.nombre}`;
        select.appendChild(option);
      });
    }

    async function cargarLugares() {
      const res = await fetch('/api/lugares');
      lugares = await res.json();
      cargarRubrosUnicos();
      renderizarLugares();
    }

    function cargarRubrosUnicos() {
      const filtroRubro = document.getElementById('filtroRubro');
      const rubrosUnicos = [...new Set(lugares.map(l => l.rubro).filter(Boolean))];
      rubrosUnicos.forEach(r => {
        const option = document.createElement('option');
        option.value = r;
        option.textContent = r;
        filtroRubro.appendChild(option);
      });
    }

    function renderizarLugares() {
      const tbody = document.getElementById('tablaLugares');
      tbody.innerHTML = '';

      const rubroFiltro = document.getElementById('filtroRubro').value.toLowerCase();
      const direccionFiltro = document.getElementById('filtroDireccion').value.toLowerCase();

      const filtrados = lugares.filter(l => {
        const coincideRubro = rubroFiltro ? l.rubro?.toLowerCase() === rubroFiltro : true;
        const coincideDireccion = direccionFiltro ? l.direccion?.toLowerCase().includes(direccionFiltro) : true;
        return coincideRubro && coincideDireccion;
      });

      filtrados.forEach(l => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><input type="checkbox" data-place-id="${l.place_id}"></td>
          <td>${l.nombre}</td>
          <td>${l.telefono}</td>
          <td>${l.rubro || ''}</td>
          <td>${l.direccion || ''}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function generarEnvios() {
      const seleccionados = [...document.querySelectorAll('tbody input[type="checkbox"]:checked')].map(cb => cb.dataset.placeId);
      const campaña = document.getElementById('campania').value;
      alert(`Enviar campaña ${campaña} a:\n\n${seleccionados.join('\n')}`);
      // Aquí deberías enviar los datos al backend si lo deseás
    }

    document.getElementById('filtroRubro').addEventListener('change', renderizarLugares);
    document.getElementById('filtroDireccion').addEventListener('input', renderizarLugares);
    document.getElementById('selectAll').addEventListener('change', function() {
      const checked = this.checked;
      document.querySelectorAll('tbody input[type="checkbox"]').forEach(cb => cb.checked = checked);
    });

    cargarCampanias();
    cargarLugares();
  </script>

</body>
</html>
