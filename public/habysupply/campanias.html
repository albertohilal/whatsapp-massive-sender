<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Campañas - Habysupply</title>
  <link rel="stylesheet" href="/habysupply/style.css">
</head>
<body>
  <h1>Campañas de Habysupply</h1>
  <script src="/habysupply/habysupply_campanias.js" defer></script>
          // Construir URL con cliente_id si es modo admin
          const params = new URLSearchParams(window.location.search);
          const clienteId = params.get('cliente');
          let url = `/habysupply/api/envios?campania_id=${campaniaId}`;
          if (clienteId) {
            url += `&cliente_id=${clienteId}`;
          }
          
          const res = await fetch(url);
          const data = await res.json();
          envios = Array.isArray(data) ? data.filter(e => e.estado === 'pendiente') : [];
        } catch (err) {
          console.error('Error al obtener destinatarios:', err);
          alert('Error al obtener destinatarios.');
          return;
        }
        if (!envios.length) {
          alert('No hay destinatarios pendientes para enviar.');
          return;
        }
        // Preparar payload para envío masivo
        // Siempre usar 'habysupply' como cliente (nombre de la sesión de WhatsApp)
        const payload = {
          envios: envios.map(e => ({ id: e.id, telefono: e.telefono_wapp, texto: e.mensaje_final })),
          cliente: 'habysupply'
        };
        try {
          const res = await fetch('/api/generar-envios', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const result = await res.json();
          if (result.enviados > 0) {
            alert(`Se enviaron ${result.enviados} mensajes.`);
            cargarEnvios(campaniaId);
          } else {
            alert('No se enviaron mensajes.');
          }
        } catch {
          alert('Error al enviar la campaña.');
        }
      });
    });
  </script>

  <script src="/dashboard_link.js"></script>
</body>
</html>
